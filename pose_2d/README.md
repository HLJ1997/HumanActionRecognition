## Human Pose Estimation
This module contains scripts to estimate human keypoints coordinates using MMPose. 
Script **run_hpe.py** allows to generate keypoints for video sequences and sequence of images. 

## API

**load_models** - load MMDetection and MMPose models (return MMDetection and MMPose models)

| Parameter name  | Default value  | Description |
| :--------- |:--------------: | :---- |
| **mmpose_path*** | - | path to MMPose |
| **hpe_method** | 'res152_coco_384x288' | HPE method (for human pose estimation) |
| **device** | 'cuda:0' if is available, else 'cpu' | used device |
| **det_checkpoint** | 'http://download.openmmlab.com/mmdetection/v2.0/faster_rcnn/faster_rcnn_r50_fpn_1x_coco/faster_rcnn_r50_fpn_1x_coco_20200130-047c8118.pth' | checkpoint for detection model |
| **det_config** | os.path.join(mmpose_path, 'demo/mmdetection_cfg/faster_rcnn_r50_fpn_1x_coco.py') | config of detection model |
| **pose_checkpoint** | 'https://download.openmmlab.com/mmpose/top_down/resnet/res152_coco_384x288_dark-d3b8ebd7_20210203.pth' | checkpoint for hpe model |
| **pose_config** | os.path.join(mmpose_path, 'demo/mmdetection_cfg/faster_rcnn_r50_fpn_1x_coco.py') | config of hpe model |

**process_2d_to_3d** - process 2D keypoints to 3D coordinates

| Parameter name  | Default value  | Description |
| :--------- |:--------------: | :---- |
| **video_pose_path*** | - | path to VideoPose3D |
| **keypoints*** | - | input keypoints used to generate 3D coordinates - shape (frames_count, joints_count, 2) |
| **model_pos*** | - | VideoPose3D model pretrained loaded using load_model function |
| **joints_left*** | - | array of left joints indexes (corresponding to input key points) |
| **joints_right*** | - | array of right joints indexes (corresponding to input key points) |
| **frame_width*** | - | number of input features for each joint (typically 2 for 2D input) |
| **frame_height*** | - | width of input frame |
| **frame_height*** | - | height of input frame |

Example:

```

```

    
## Script


### Options:
- *mmpose-path* - absolute path to MMPose project (if not set, by default is used this one, set in config.ini from main project directory)
- *hpe-method* - used HPE algorithm (by default *res152_coco_384x288*)
- *output-directory* - directory where results (keypoints coordinates) will be generated (default is *./results*)
- *dataset-path* - absolute path to input dataset (**required**)
- *video* - flag that defines if given input data are video sequences or multiple images (by default it is assumed that input is array of immages)
- *filter* - filter input files of dataset
- *generate-video*  - flag that defines if MMPose should generate output videos with marked estimated keypoints on them

Output contains poses and bounding box-es for analysed sequences. 

MMPose installation and configuration process is described here: https://github.com/open-mmlab/mmpose
MMPose require also MMDetection to be installed: https://github.com/open-mmlab/mmdetection
All available methods are mentioned in *./hpe_utils/bottom_up_config.py* and *./hpe_utils/top_down_config.py*.

### Examples

#### Video sequence

Example command:

```
python run_hpe.py \
    --mmpose-path /home/user/mmpose \
    --dataset-path /home/user/dataset/cluster1 \
    --video
```

The most important point for video sequence is adding *--video* flag (without that, all videos in directory will be treated as images).
Dataset can contains multiple nested directories, but having this same structure (depth).

Below You can see an example dataset tree:

```
dataset/
├─ cluster1/
│  ├─ cam1/
│  │  ├─ action1/
│  │  │  ├─ video_001.avi
│  │  │  ├─ video_002.avi
│  │  │  ├─ video_003.avi
│  │  ├─ action2/
│  │  │  ├─ video_001.avi
│  │  │  ├─ video_002.avi
│  │  │  ├─ video_003.avi
│  ├─ cam2/
│  │  ├─ action1/
│  │  │  ├─ video_001.avi
│  │  │  ├─ video_002.avi
│  │  │  ├─ video_003.avi
│  │  ├─ action2/
│  │  │  ├─ video_001.avi
│  │  │  ├─ video_002.avi
│  │  │  ├─ video_003.avi

```
\* in case of any problem You need to ensure that the deepest folder contains only videos

Output structure:

```
results/
├─ cluster1/
│  ├─ cam1/
│  │  ├─ action1/
│  │  │  ├─ res152_coco_384x288
│  │  │  │  ├─  csv
│  │  │  │  │  ├─  bbox
│  │  │  │  │  |  ├─  video_001
│  │  │  │  │  |  |  ├─  video_001_bounding_box_0.csv
│  │  │  │  │  |  |  ├─  video_001_bounding_box_1.csv
│  │  │  │  │  |  ├─  video_002
│  │  │  │  │  |  |  ├─  video_002_bounding_box_0.csv
│  │  │  │  │  |  |  ├─  video_002_bounding_box_1.csv
│  │  │  │  │  ├─  pose_results
│  │  │  │  │  |  ├─  video_001
│  │  │  │  │  |  |  ├─  video_001_pose_0.csv
│  │  │  │  │  |  |  ├─  video_001_pose_1.csv
│  │  │  │  │  |  ├─  video_002
│  │  │  │  │  |  |  ├─  video_002_pose_0.csv
│  │  │  │  │  |  |  ├─  video_002_pose_1.csv
```

If *video* options is given, then video directory with sequence generated by MMPose will be placed on the level of csv directory.

#### Images sequence

Example command:

```
python run_hpe.py \
    --mmpose-path /home/user/mmpose \
    --dataset-path /home/user/dataset/cluster1
```

Dataset can contains multiple nested directories, but having this same structure (depth).

Below You can see an example dataset tree:

```
dataset/
├─ cluster1/
│  ├─ cam1/
│  │  ├─ action1/
│  │  │  ├─ img_001.png
│  │  │  ├─ img_002.png
│  │  │  ├─ img_003.png
│  │  ├─ action2/
│  │  │  ├─ img_001.png
│  │  │  ├─ img_002.png
│  │  │  ├─ img_003.png
│  ├─ cam2/
│  │  ├─ action1/
│  │  │  ├─ img_001.png
│  │  │  ├─ img_002.png
│  │  │  ├─ img_003.png
│  │  ├─ action2/
│  │  │  ├─ img_001.png
│  │  │  ├─ img_002.png
│  │  │  ├─ img_003.png

```
\* in case of any problem You need to ensure that the deepest folder contains only videos


Output structure:


```
results/
├─ cluster1/
│  ├─ cam1/
│  │  ├─ action1/
│  │  │  ├─ res152_coco_384x288
│  │  │  │  ├─  csv
│  │  │  │  │  ├─  bbox
│  │  │  │  │  |  ├─  img_001
│  │  │  │  │  |  |  ├─  img_001_bounding_box_0.csv
│  │  │  │  │  |  |  ├─  img_001_bounding_box_1.csv
│  │  │  │  │  |  ├─  img_002
│  │  │  │  │  |  |  ├─  img_002_bounding_box_0.csv
│  │  │  │  │  |  |  ├─  img_002_bounding_box_1.csv
│  │  │  │  │  ├─  pose_results
│  │  │  │  │  |  ├─  img_001
│  │  │  │  │  |  |  ├─  img_001_pose_0.csv
│  │  │  │  │  |  |  ├─  img_001_pose_1.csv
│  │  │  │  │  |  ├─  img_002
│  │  │  │  │  |  |  ├─  img_002_img_pose_0.csv
│  │  │  │  │  |  |  ├─  img_002_img_pose_1.csv
```

If *video* options is given, then video directory with sequence generated by MMPose will be placed on the level of csv directory.