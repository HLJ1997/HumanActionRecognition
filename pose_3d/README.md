# 3D pose generation

This module contains scripts to generate 3D coordinates from 2D, using VideoPose3D. 
Script **run_pose_3d.py** allows to generate 3D coordinates basis on 2D coordinates.
This script basis on 2D coordinates generated by MMPose.
This script is intended only for single pose videos (from all poses generated by MMPose for input video, only best one for each frame is selected).

## API

**load_model** - load VideoPose3D model pretrained on h36m dataset

| Parameter name  | Default value  | Description |
| :--------- |:--------------: | :---- |
| **video_pose_path*** | - | path to VideoPose3D |
| **num_joints_in*** | - | number of input joints (e.g. 17 for Human3.6M) |
| **num_joints_out** | None | number of output joints (can be different than input) - if not defined 'num_joints_out == num_joints_in' |
| **in_features** | 2| number of input features for each joint (typically 2 for 2D input) |

**process_2d_to_3d** - process 2D keypoints to 3D coordinates

| Parameter name  | Default value  | Description |
| :--------- |:--------------: | :---- |
| **video_pose_path*** | - | path to VideoPose3D |
| **keypoints*** | - | input keypoints used to generate 3D coordinates - shape (frames_count, joints_count, 2) |
| **model_pos*** | - | VideoPose3D model pretrained loaded using load_model function |
| **joints_left*** | - | array of left joints indexes (corresponding to input key points) |
| **joints_right*** | - | array of right joints indexes (corresponding to input key points) |
| **frame_width*** | - | number of input features for each joint (typically 2 for 2D input) |
| **frame_height*** | - | width of input frame |
| **frame_height*** | - | height of input frame |

    
## Script

### Options
- *video-pose-3d-path* - Absolute path to VideoPose3D (if not set, by default is used this one, set in config.ini from main project directory)
- *output-directory* - Path to generated results output directory (default='./results/')
- *input-directory* - Path to input data **required**
- *frame-width* - Width of frame **required**
- *frame-height* - Height of frame **required**
- *generate-2D* - Generate 2D coordinates too (by default only 3D are generated)
- *joints-count* - Count of joints given as input (by default 17)
- *joints-left* - Joints from left part of silhouette (by default [1, 3, 5, 7, 9, 11, 13, 15])
- *joints-right* - Joints from right part of silhouette (by default [2, 4, 6, 8, 10, 12, 14, 16])

VideoPose3D installation and configuration process is described here https://github.com/facebookresearch/VideoPose3D

### Examples

Example commands:

```
python run_pose_3d.py \
    --input-directory ../datasets_unprocessed/test1 \
    --output-directory ./datasets_processed/test1 \
    --frame-width 1080 \
    --frame-height 1920 \
    --generate-2D

python run_pose_3d.py \
    --input-directory ../datasets_unprocessed/test1 \
    --output-directory ./datasets_processed/test1 \
    --frame-width 1080 \
    --frame-height 1920 \
    --joints-count 17 \
    --joints-left 1 3 5 7 9 11 13 15 \
    --joints-right 2 4 6 8 10 12 14 16 \
    --generate-2D
```

As it was mentioned before, script uses 2D coordinates generated by MMPose. 
Structure of this file should be similar to this one generated by *run_hpe.py* script, which is loacted in module *hpe* of this project.

Example structure of input dataset to process:

```
dataset/
├─ ntu_rgbd/
│  ├─  video_001
│  |  ├─  video_001_pose_0.csv
│  |  ├─  video_001_pose_1.csv
│  |  ├─  video_002_pose_0.csv
│  |  ├─  video_002_pose_1.csv
│  |  ├─  video_002_pose_1.csv
```

**IMPORTANT**

In order to use 3D pose generator script with poses generated by *hpe* module, directory structure needs to be changed - below bash commands can be used inside input dataset directory.
```
for i in $(find -type d -name bbox); do rm -rf $i; done
for i in $(find -type d -name pose_results); do mv $i/* $i/..; done
for i in $(find -type d -name pose_results); do rmdir $i; done
for i in $(find -type d -name "res152_coco_384x288"); do mv $i/csv/* "$i/.."; done
for i in $(find -type d -name csv); do rmdir $i; done
for i in $(find -type d -name res152_coco_384x288); do rmdir $i; done
```
